

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>通过钢铁侠变身快速理解Python的装饰器用法 &#8212; DE8UG小灶时间</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-dropdown.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/logo-xiaozao.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">DE8UG小灶时间</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Welcome to your Jupyter Book
  </a>
 </li>
</ul>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="content.html">
   Content in Jupyter Book
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/py-basic-deco.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/de8ug/book_xiaozao/master?urlpath=tree/py-basic-deco.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/de8ug/book_xiaozao/blob/master/py-basic-deco.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   1 一切都要从函数说起
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   2 装饰器@魔法出现了
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   3 装饰器的变身
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     传递参数
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     多重装饰器
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     发现函数名问题
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     如果装饰器加参数呢
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id8">
   4 装饰器的用途
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="python">
<h1>通过钢铁侠变身快速理解Python的装饰器用法<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>1 一切都要从函数说起<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>我们都知道一个函数可以返回一些数据，然后这些数据可以被其他函数调用。函数里还可以有若干个参数，可以让函数根据不同的输入值进行不同的计算，然后得到新的结果。</p>
<p>于是，我们的故事就可以开始了。</p>
<p>现有第一个函数，tony，很简单，直接返回tony，然后你叫他一声。他就回应你：tony。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tony</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;tony&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tony</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;tony&#39;
</pre></div>
</div>
</div>
</div>
<p>紧接着，我们来到第二个函数，他可以根据传入的一个男人man，然后说出谁是钢铁侠。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">iron_man</span><span class="p">(</span><span class="n">man</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">man</span><span class="si">}</span><span class="s1"> is iron man!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>由于在Python里面任何东西都是个对象，函数也不例外，我们就直接把上面的<code class="docutils literal notranslate"><span class="pre">tony()</span></code>（注意括号啊！）直接传给<code class="docutils literal notranslate"><span class="pre">iron_man</span></code>，会得到什么呢？
如你所见，结果很简单，当做参数的函数，返回值传入了新的函数，然后组合出现了我们看到的结果。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iron_man</span><span class="p">(</span><span class="n">tony</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tony is iron man!
</pre></div>
</div>
</div>
</div>
<p>刚才只是简单的说一下谁是钢铁侠，下面他就要变身了。</p>
<p>既然函数可以当做参数，那么我们在定义复杂一点的函数。如下所示，把函数名func当做参数，然后嵌套写一个包装函数 wrapper，这个函数里面调用func，这时候是有括号的，当做他的变身。
同时这行代码的上下，分别添加语句，分别显示变身前和变身后。</p>
<p>这个函数的最后，返回的是内部包裹的函数名，其实就是个函数对象，但是，没有调用呢。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tony要变身</span>
<span class="k">def</span> <span class="nf">deco_iron</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;开始准备变身&#39;</span><span class="p">)</span>
        <span class="n">man</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">man</span><span class="si">}</span><span class="s1"> 正在变身!&#39;</span><span class="p">)</span>        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;变身结束！&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
</div>
</div>
<p>接下来，我们调用这个复杂函数，就可以完成钢铁侠的变身了。和刚才不同的是，注意我们只是传入函数名。因为这个函数要在刚才包裹他的函数内部运行。
我们可以给个新的变量new_tony，注意咯，这时候得到的是刚才复杂函数的返回值，也就是内部的函数对象。如果要调用，需要加括号的。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_tony</span> <span class="o">=</span> <span class="n">deco_iron</span><span class="p">(</span><span class="n">tony</span><span class="p">)</span>  <span class="c1"># 注意！！没有括号，去变身里面执行</span>
</pre></div>
</div>
</div>
</div>
<p>试一下就知道了。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_tony</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>开始准备变身
tony 正在变身!
变身结束！
</pre></div>
</div>
</div>
</div>
<p>如你所见，变身成功。下面问题来了：有没有可能直接运行tony就达到效果？</p>
<p>当然有，我们把刚才的返回值变量直接写作tony，运行看看：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tony</span> <span class="o">=</span> <span class="n">deco_iron</span><span class="p">(</span><span class="n">tony</span><span class="p">)</span>
<span class="n">tony</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>开始准备变身
tony 正在变身!
变身结束！
</pre></div>
</div>
</div>
</div>
<p>回顾一下，我们现在相当于还是调用名为tony的函数，但是，在没有改变原来函数的情况下，我们给他添加了整套的变身语句。如同钢铁盔甲增强了tony的身体素质，我们用了一个嵌套函数增强了刚才简简单单的tony函数，但其实从头到尾没有修改原来的tony函数。这就给代码增添了无限的可能。</p>
<p>但，这样调用来调用去的有点啰嗦，需要简化。</p>
</div>
<div class="section" id="id2">
<h2>2 装饰器&#64;魔法出现了<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Python是一个以简洁著称的语言，刚才那种写完嵌套函数，调用一下，又返回同样的函数名，然后等着再调用的做法，直接可以用一个<code class="docutils literal notranslate"><span class="pre">&#64;</span></code>符号搞定。
这时候的<code class="docutils literal notranslate"><span class="pre">&#64;</span></code>相当于<code class="docutils literal notranslate"><span class="pre">tony</span> <span class="pre">=</span> <span class="pre">deco_iron(tony)</span></code>，然后直接加到原来的函数上头就ok了。如下所示：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@deco_iron</span>
<span class="k">def</span> <span class="nf">tony</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;tony&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>调用一下这个函数，你会发现已经被装饰加强了。这就是装饰器了。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tony</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>开始准备变身
tony 正在变身!
变身结束！
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>3 装饰器的变身<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3>传递参数<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>函数是可以传递参数的，如果我们想让被装饰的函数传递参数可以这样做：</p>
<ul class="simple">
<li><p>正常添加任何参数，比如我们这里加个msg</p></li>
<li><p>在装饰器函数的内部函数中，使用<code class="docutils literal notranslate"><span class="pre">*args,</span> <span class="pre">**kw</span></code>接收任何参数就ok了</p></li>
</ul>
<p>为了刚方便查看测试效果，我们这里再用<code class="docutils literal notranslate"><span class="pre">func.__name__</span></code>格式化输出一下函数名。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 传递参数</span>
<span class="k">def</span> <span class="nf">deco_iron</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron开始运行....&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;开始变身，在执行</span><span class="si">{}</span><span class="s1">函数前&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;钢铁侠变身完成，结束</span><span class="si">{}</span><span class="s1">函数&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
</div>
</div>
<p>下面，从新装饰一下tony函数，你会发现，定义之后就会自动运行上面装饰器函数的第一句话。其实这就是在Python内部，自动完成了<code class="docutils literal notranslate"><span class="pre">tony</span> <span class="pre">=</span> <span class="pre">deco_iron(tony)</span></code>，悄悄第一次运行了整个装饰器函数。接下来我们要调用一下下面的函数，才会运行外部函数的返回结果，从而进入的最内部的函数。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@deco_iron</span>
<span class="k">def</span> <span class="nf">tony</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tony说：</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deco_iron开始运行....
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tony</span><span class="p">(</span><span class="s1">&#39;我来啦！&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>开始变身，在执行tony函数前
(&#39;我来啦！&#39;,) {}
tony说：我来啦！
钢铁侠变身完成，结束tony函数
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>多重装饰器<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>单层的装饰器说完了。下面说一下多重装饰器。比如钢铁侠，有时候要去和更强大的敌人战斗，需要多穿一层盔甲。</p>
<p>于是，DE8UG新写个带new后缀的函数，同时在里面适当修改提示语句。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 多重装饰器</span>
<span class="k">def</span> <span class="nf">deco_iron_new</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron_new开始运行....&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron_new 开始变身，在执行</span><span class="si">{}</span><span class="s1">函数前&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron_new 钢铁侠变身完成，结束</span><span class="si">{}</span><span class="s1">函数&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
</div>
</div>
<p>接下来就是使用了。只需要在要装饰的函数上，依次往上叠加&#64;装饰函数名，就ok。这时候，定义语句被执行时候，你会发现同样执行了装饰器里面的第一句说明。</p>
<p>看一下执行顺序，是按照装饰顺序，从内到外执行的。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@deco_iron_new</span>
<span class="nd">@deco_iron</span>
<span class="k">def</span> <span class="nf">tony</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tony说：</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deco_iron开始运行....
deco_iron_new开始运行....
</pre></div>
</div>
</div>
</div>
<p>但，我们需要注意的是，当实际执行tony函数时，会发生什么，先看结果再解释。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tony</span><span class="p">(</span><span class="s1">&#39;我要超级变身&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deco_iron_new 开始变身，在执行wrapper函数前
(&#39;我要超级变身&#39;,) {}
开始变身，在执行tony函数前
(&#39;我要超级变身&#39;,) {}
tony说：我要超级变身
钢铁侠变身完成，结束tony函数
deco_iron_new 钢铁侠变身完成，结束wrapper函数
</pre></div>
</div>
</div>
</div>
<p>你会发现一个有意思的现象，实际执行的函数，是按照装饰的层次，从外到内执行了。</p>
<p>为什么呢？
仔细思考上文的装饰器语法含义，我们会发现刚才定义时，从内到外执行的多个装饰器函数，每个装饰器函数都返回一个函数对象。这时候最外层的返回函数对象当然就在最外面了。
当被装饰后的函数具体执行时，就像剥洋葱一样，从外到内，一层层的执行具体的语句。</p>
</div>
<div class="section" id="id6">
<h3>发现函数名问题<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>相信眼尖的同学看出来了，刚才多层装饰器一次出现的说明语句，对于函数名的解析，似乎有点问题，最外层的没有正确说明要执行的tony函数。</p>
<p>这是为什么？</p>
<p>在函数执行的时候，会有自己的变量作用域，当多层嵌套的装饰器执行时，虽然运行不出错，但其实内部的作用域出现的混乱。比如我们看见的错误的显示了内嵌函数的名称。</p>
<p>这个怎么解决呢，Python自己带来的问题，当然可以自己解决。直接使用functools里的wraps装饰器，来修复这个作用域问题。用法就是在内嵌函数上装饰一下，记住原函数信息。</p>
<p>再次运行一下，你会发现函数名已经正常显示了。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="c1"># 多重装饰器</span>
<span class="k">def</span> <span class="nf">deco_iron_new</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron_new 开始运行....&#39;</span><span class="p">)</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron_new 开始变身，在执行</span><span class="si">{}</span><span class="s1">函数前&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron_new 钢铁侠变身完成，结束</span><span class="si">{}</span><span class="s1">函数&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="c1"># 传递参数</span>
<span class="k">def</span> <span class="nf">deco_iron</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron开始运行....&#39;</span><span class="p">)</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;开始变身，在执行</span><span class="si">{}</span><span class="s1">函数前&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;钢铁侠变身完成，结束</span><span class="si">{}</span><span class="s1">函数&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@deco_iron_new</span>
<span class="nd">@deco_iron</span>
<span class="k">def</span> <span class="nf">tony</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tony说：</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deco_iron开始运行....
deco_iron_new 开始运行....
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tony</span><span class="p">(</span><span class="s1">&#39;再次变身&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deco_iron_new 开始变身，在执行tony函数前
(&#39;再次变身&#39;,) {}
开始变身，在执行tony函数前
(&#39;再次变身&#39;,) {}
tony说：再次变身
钢铁侠变身完成，结束tony函数
deco_iron_new 钢铁侠变身完成，结束tony函数
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id7">
<h3>如果装饰器加参数呢<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>下面再来个复杂点的。既然装饰器本身还是函数，那么当然可以继续添加参数。</p>
<p>怎么加呢？
再嵌套一层函数，把参数传给它！</p>
<p>比如，钢铁侠要带着小辣椒一起飞，可以这么写：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如果装饰器加参数呢？</span>
<span class="k">def</span> <span class="nf">deco_params</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">deco_iron</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deco_iron开始运行....&#39;</span><span class="p">)</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;新参数需要处理：&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;开始变身，在执行</span><span class="si">{}</span><span class="s1">函数前&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;钢铁侠变身完成，结束</span><span class="si">{}</span><span class="s1">函数&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">deco_iron</span>


<span class="nd">@deco_params</span><span class="p">(</span><span class="s1">&#39;小辣椒&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tony</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tony说：</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deco_iron开始运行....
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tony</span><span class="p">(</span><span class="s1">&#39;hi, 小辣椒&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>新参数需要处理： 小辣椒
开始变身，在执行tony函数前
tony说：hi, 小辣椒
钢铁侠变身完成，结束tony函数
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>4 装饰器的用途<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>Python中，装饰器的用途很多。我们举一个web应用的例子。</p>
<p>我们都知道一个网站往往会有多个连接，根据不同的连接地址，进行路由转发，可以显示不同的业务内容。于是，我们可以这样定义一个类MyApp，表示网络应用。</p>
<p>里面放置三个函数，完成路由转发的功能：</p>
<ul class="simple">
<li><p>初始化函数，放置一个字典</p></li>
<li><p>注册函数，用来当其他业务函数的装饰器。这是个嵌套函数，里面可以根据不同的路由页面名称，把函数名保存到字典</p></li>
<li><p>实际页面调用函数。</p></li>
</ul>
<p>接下来使用时，可以很方便把不同页面的响应函数，注册到不同的路由下面。当访问不同页面时，根据响应的参数直接调用同一个方法，就能自动去转换到对应的页面内容了。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 装饰器,各种用途</span>
<span class="c1"># author: De8uG</span>


<span class="k">class</span> <span class="nc">MyApp</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_map</span> <span class="o">=</span> <span class="p">{}</span>
 
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;func_wrapper: &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func_wrapper</span>
 
    <span class="k">def</span> <span class="nf">call_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No function registered against - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">()</span>


<span class="c1"># 创建对象，用于添加方法进行调用</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">MyApp</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main_page_func</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;This is the main page.&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;/next_page&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">next_page_func</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;This is the next page.&quot;</span>


<span class="nb">print</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">call_method</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">call_method</span><span class="p">(</span><span class="s1">&#39;/next_page&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>func_wrapper:  / &lt;function main_page_func at 0x7ffdf843d050&gt;
func_wrapper:  /next_page &lt;function next_page_func at 0x7ffdf843db00&gt;
(&#39;/&#39;, &#39;This is the main page.&#39;)
(&#39;/next_page&#39;, &#39;This is the next page.&#39;)
</pre></div>
</div>
</div>
</div>
<p>ok，以上就是DE8UG给你带来的装饰器的相关知识了。你学会了吗？有任何问题，建议欢迎到「Python随身听」留言，感谢关注🤗。</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "edu"
        },
        kernelOptions: {
            kernelName: "edu",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'edu'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By DE8UG<br/>
        
            &copy; Copyright 2020.<br/>
          <div class="extra_footer">
            更多内容与问题讨论请到「Python随身听」<image width=80 src="https://upload.jianshu.io/users/qrcodes/543964/%E5%BE%AE%E4%BF%A1-%E7%AC%AC8%E5%93%A5.jpg">
          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="_static/js/index.js"></script>
    
  </body>
</html>